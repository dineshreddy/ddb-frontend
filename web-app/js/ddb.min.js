var Ddb={Data:{},Funcs:{},Pages:{},Services:{},ThirdParty:{},ViewModels:{},Widgets:{}};Ddb.AjaxPath="";Ddb.WindowToMessage=null;Ddb.Login=false;if(!Object.keys){Object.keys=function(c){var b=new Array();for(var a in c){if(c.hasOwnProperty(a)){b.push(a)}}return b}}Ddb.Dictionary=function(){this.GetOrAdd=function(b,a){var c=this[b];if(!c){c=this[b]=a()}return c}};Ddb.Publisher=function(){var a=new Ddb.Dictionary();this.Get=function(b){return a.GetOrAdd(b,function(){return new Rx.BehaviorSubject()})};this.Publish=function(c,b){this.Get(c).OnNext(b)};this.Subscribe=function(c,b){return this.Get(c).Subscribe(b)};return this}();Ddb.Funcs.CheckSubscribers=function(a){return($.inArray(true,$.map(Ddb.Widgets,function(b){return(b.Data.widget==a)}))!=-1)};Ddb.Funcs.AddWidget=function(){var a=$("div."+this.getAttribute("data-target")),b=this.getAttribute("data-url");registerWidget(a,b);return false};Ddb.Funcs.InsertWidget=function(b,c,a){registerWidget(b,c,a);return false};var registerWidget=function(b,c,a){$.ajax({beforeSend:function(d){d.setRequestHeader("Accept","application/vnd.openrasta.htmlfragment+xml")},type:"GET",url:c,dataType:"html",success:function(d){var e=$(d);e.show().appendTo(b).RegisterWidget();if(a){a(e)}}})};Ddb.Funcs.ThirdPartyMessaging=function(){$(window).bind("message",function(b){if(b.originalEvent.origin!=window.location.origin){return}var a=JSON.parse(b.originalEvent.data);Ddb.Publisher.Publish(a.topic,a.data,true)})};Ddb.Funcs.DecodeEntities=function(a){var b=document.createElement("p");b.innerHTML=a;a=b.textContent||b.innerText;return a};var forceRedrawIE=function(a){if(!a||!$.browser.msie){return}a.each(function(d,c){var b=$(c);if(b.is(":hidden")){b.show().hide()}else{b.hide().show()}})};var Resources=function(){amplify.request.decoders.appEnvelope=function(a,c,e,d,b){switch(c){case"success":d(a,e);break;default:b(e.status);break}};amplify.request.define("postSearchResults","ajax",{url:"/searchresults",dataType:"json",type:"POST",decoder:"appEnvelope"});amplify.request.define("getFacetValues","ajax",{url:"/facetresults?searchQuery={searchQuery}&facetNames={facetNames}",type:"GET",dataType:"json",decoder:"appEnvelope"});amplify.request.define("getFacetValuesWithSelectedFacets","ajax",{url:"/facetresults?searchQuery={searchQuery}&facetName={facetName}&selectedFacets={selectedFacets}",type:"GET",dataType:"json",decoder:"appEnvelope"});amplify.request.define("getObjectProperties","ajax",{url:"/access/{id}/facets",dataType:"json",type:"GET",decoder:"appEnvelope"});amplify.request.define("getObjectParents","ajax",{url:"/access/{id}/parents",dataType:"json",type:"GET",decoder:"appEnvelope"});amplify.request.define("getObjectChildren","ajax",{url:"/access/{id}/children?include={includeChildId}",dataType:"json",type:"GET",decoder:"appEnvelope"});amplify.request.define("getSearchResults","ajax",{url:"/searchresults",dataType:"json",type:"GET",decoder:"appEnvelope",cache:false});amplify.request.define("getSearchFacetValues","ajax",{url:"/facets?name={name}",type:"GET",contentType:"application/json; charset=utf-8",dataType:"json",decoder:"appEnvelope",cache:false});amplify.request.define("getInstitutionMap","ajax",{url:"/institutions/map?clusterId={clusterId}&offset={offset}&size={size}",type:"GET",contentType:"application/json; charset=utf-8",dataType:"json",decoder:"appEnvelope",cache:true})};(function(a){var b=Ddb.Pages.AdvancedSearchPage={};b.init=function(s){var t=new Ddb.LargeCookie("advancedsearch");var u={groupWidget:".groupWidget",group:".queryGroup",removeGroupButton:"button.removeGroupButton",addGroupButtonContainer:".addGroupButtonContainer",addGroupButton:"button.addGroupButton",row:".queryRow",removeButton:"button.removeButton",addButton:"button.addButton",resetButton:"button[type='reset']",facet:"select.facet",facetDisabled:"select.facet_disabled",operator:"select.operator",globalOperator:".globalOperator",value:"input.value",matchValue:"select.matchValue",facetValues:"select.facetValues",facetValueIdAttribute:"data-inputid",contextualHelp:"span.contextualHelp",contextualHelpTooltip:"div.tooltip"};function x(D){if(!D){return}var E=h(D);D.find(u.value).hide();D.find(u.facetValues).hide();E.show();var F=E.filter(u.value).length===0;if(F){a(u.matchValue,D).hide()}else{a(u.matchValue,D).show()}}function h(D){var G=D.find(u.facet).val();var E=a("option["+u.facetValueIdAttribute+"][value='"+G+"']",D);var F=D.find("#"+E.attr(u.facetValueIdAttribute));return F}function i(D){return h(D).val()}function j(D){var E=false;a(u.row,D).each(function(){if(i(a(this))){E=true;return false}});return E}function n(D){var E=D;D.nextAll(":visible").andSelf().filter(u.groupWidget).each(function(){var J=a(this),K=[u.facet,u.value,u.matchValue,u.facetValues],I=a(u.row,E),G=a(u.row,J);var H=a(u.operator,E);var F=a(u.operator,J);H.val(F.val());p(F);I.each(function(O,N){var L=a(G.get(O));var M=a(this);a(K).each(function(R,S){var Q=a(S,M);var P=a(S,L);Q.each(function(U,V){var T=a(P[U]);a(this).val(T.val())})});if(L.is(":visible")){M.show()}else{M.hide()}x(M);r(L)});B(E);E=J});return E.slideUp(100,function(){q(E);A()})}function y(){a(u.groupWidget,s).filter(":hidden:first").slideDown(100,function(){A();B(a(u.group,this))})}function d(){a(u.facet,s).change(function(){var D=a(this).closest(u.row);x(D)})}function f(){a(u.removeGroupButton,s).click(function(){var D=a(this).closest(u.groupWidget);n(D);return false});a(u.addGroupButton,s).click(function(){y();return false})}function v(){a(u.groupWidget,s).each(function(E){var D=a(this).find(u.group);if(E===0||j(a(this))){a(this).show()}else{q(D)}l(D)})}function l(D){w(D);g(D)}function w(E){var D;a(u.row,E).each(function(G){var F=a(this);if(G===1||i(F)){D=a(this);x(F)}else{r(F)}});D.prevAll().andSelf().show(function(){B(E)})}function g(D){a(u.addButton,D).click(function(){z(D);return false});a(u.removeButton,D).click(function(){var E=a(this).closest(u.row);o(E,D);return false})}function z(E){var D=a(u.row,E).filter(":hidden").first();return D.slideDown(100,function(){B(E);a(u.facet,a(this)).focus()})}function o(E,F){var D=E;E.nextAll(":visible").andSelf().each(function(){var G=a(this),H=[u.facet,u.value,u.matchValue,u.facetValues];a(H).each(function(K,L){var J=a(L,D);var I=a(L,G);J.each(function(N,O){var M=a(I[N]);a(this).val(M.val());p(M)})});x(D);x(G);D=G});return D.slideUp(100,function(){B(F)})}function A(){var D=a(u.groupWidget,s);if(D.filter(":hidden").length==0){a(u.addGroupButtonContainer,s).hide();a(u.removeGroupButton,s).show();a(u.globalOperator,s).show()}else{if(D.filter(":visible").length==1){a(u.addGroupButtonContainer,s).show();a(u.removeGroupButton,s).hide();a(u.globalOperator,s).hide()}else{a(u.removeGroupButton,D.filter(":visible")).show();a(u.addGroupButtonContainer,s).show();a(u.globalOperator,s).show()}}a("select",D.filter(":visible:last")).first().focus()}function B(F){var D=a(u.row,F);var E=D.filter(":visible");a(u.addButton,E).hide();if(E.length<=1){a(u.removeButton,E).hide()}else{a(u.removeButton,E).show()}if(E.length===D.length){a(u.addButton,F).hide()}else{a(u.addButton,E.last()).show()}}function q(D){var E=a(u.row,D);E.first().show().next().show();E.slice(2).hide();B(D);var F=[u.operator,u.facet,u.value,u.matchValue,u.facetValues];a(F,D).each(function(G,H){p(a(H,D))});E.each(function(G,H){r(a(this))})}function r(D){var E=[u.facet,u.value,u.matchValue,u.facetValues];a(E).each(function(F,G){p(a(G,D))});x(D)}function p(D){D.each(function(E,F){if(a(F).is("select")){if(F.selectedIndex!=0){F.selectedIndex=0}}else{if(F.value){F.value=""}}})}function e(){a(u.resetButton,s).click(function(){t.del();a(u.group,s).each(function(D,E){p(a(u.globalOperator,s));q(this)});a(u.groupWidget,s).first().show().end().slice(1).hide();A()})}function c(){var D;a(u.contextualHelp,s).removeAttr("title").unbind("mouseover").bind("mouseover",function(){clearTimeout(D);var E=a(u.contextualHelpTooltip,s);E.fadeIn();E.bind("mouseenter",function(){clearTimeout(D)}).bind("mouseleave",function(){D=setTimeout(function(){E.fadeOut()},500)})}).bind("mouseout",function(){D=setTimeout(function(){a(u.contextualHelpTooltip,s).fadeOut()},3000)})}function k(){d();f();v();A()}function C(){var E=a(u.facet,s);var D=a(u.facetDisabled,s);D.each(function(F,G){var H=E[F];a(this).attr("class",H.className).removeAttr("disabled").show();a(H).attr("class","").attr("disabled","disabled").hide()})}function m(){var D=t.get();if(D){var E=D.split("&");_.each(E,function(F){var G=F.split("=");a('[name="'+G[0]+'"]').val(unescape(G[1]))})}a("form#advancedSearchQueryForm",s).bind("submit",function(){var F=[];a(this).serialize().replace(/([^=&]+)=([^=&]+)/ig,function(G,H,I){F.push(H+"="+escape(decodeURIComponent((I).replace(/\+/g,"%20"))));return null});t.set(F.join("&"))})}C();m();k();e();c()}}(jQuery));(function(){Ddb.ViewModels.SlideScroller=function(q,o,p){var u=this;var k=false;var q=$(q);q.data("scroller",this);var s=$("<ul></ul>");$(q).append(s);var t;var r;var m=140;var v=3;var g=0;var f=_.find(p,function(w){return w.primary});var j=f?_.indexOf(p,f):0;var l=_.map(p,function(w){var x=new Ddb.ViewModels.Slide(w.shortType,w.name,w.thumbnail,w.uri,w.full_uri,w.poster,$("<li></li>"));x.getDomElement().bind("clicked.Slide",function(y){q.trigger({type:"slideSelected.SlideScroller",slide:y.slide})});return x});_.each(l,function(x,w,y){if(w>0){x.prev(y[w-1])}if(w<y.length-1){x.next(y[w+1])}});var e=l[0];var n=e;var b,a;var i=function(){b=$("<button/>").text("Prev").addClass("btnPrev").append("<span/>").click(function(){d(g-v,g);c()});a=$("<button/>").text("Next").addClass("btnNext").append("<span/>").click(function(){d(g+v,g+(v*2));c()});q.css({overflow:"hidden"});s.css({position:"relative"});q.append(a);q.prepend(b)};var c=function(){var x=l.length;if(b){var w=Math.max(g,0);if(x<v||l[w].prev()==null){b.attr("disabled","disabled");b.children("span").addClass("opaque")}else{b.removeAttr("disabled");b.children("span").removeClass("opaque")}}if(a){var y=Math.min(g+(v-1),x-1);if(x<v||l[y].next()==null){a.attr("disabled","disabled");a.children("span").addClass("opaque")}else{a.removeAttr("disabled");a.children("span").removeClass("opaque")}}setTimeout(function(){$(".scroller li").each(function(){$(".scroller li").css("visibility","visible");if(!$(this).is(":animated")){var z=parseInt($(this).css("left").replace(/[^-\d\.]/g,""));if(z>320){$(this).css("visibility","hidden")}}})},100)};var d=function(z,y){_.each(s.children(),function(A){$(A).data("slide").invisible()});s.empty();g=z;var w=l[z];var x=0;while(w!=null&&x<y-z){w.left(x*m);w.visible();s.append(w.getDomElement());w=w.next();x++}};var h=function(){if(t==null){t=q.width()}if(r==null){r=q.height()}if(j==0){d(0,v)}else{var w=(u.roundDownToMultiple(j,v)/3);d(w*v,(w+1)*v)}i();c()};this.getDomElement=function(){return q.get(0)};this.getInitialBinary=function(){return l.length>0?l[j]:null};this.show=function(){q.show();if(!k){h();k=true}};this.hide=function(){q.hide()};this.roundDownToMultiple=function(x,w){return Math.floor(x/w)*w}}}());(function(){Ddb.ViewModels.CultureItemViewModel=function(){this.selectedBinary=ko.observable();this.currentScroller=ko.observable();this.slideScrollers=ko.observableArray([]);this.addSlideScroller=function(c,b,a){this.slideScrollers.push(new Ddb.ViewModels.SlideScroller(c,b,a))}}}());(function(){Ddb.ViewModels.Slide=function(c,i,s,d,g,n,f){var q=this;var h=false;var e=$(f);e.css({position:"absolute",top:0});var b=$("<a></a>");b.attr("href",d);b.attr("data-fullsrc",g);b.attr("data-poster",n);b.attr("title",i);b.click(function(a){a.stopPropagation();a.preventDefault();e.trigger({type:"clicked.Slide",slide:q})});e.append(b);e.data("slide",this);var t=$("<div></div>").addClass("thumbnail").addClass(c);b.append(t);var r=$("<img/>").load(function(){r.parent().css("background","white");r.fadeIn(300).css("display","inline-block")});r.hide();t.append(r);var j=$("<span>"+i+"</span>").addClass("label");b.append(j);var m,k,p,o,l;e.find(".thumbnail").append(r);e.bind("visible.Slide",function(){if(!h){q.loadThumbnail();h=true}});this.getLabel=function(){return i};this.getBinaryUrl=function(){return d};this.getFullSizeUrl=function(){return g};this.getPosterUrl=function(){return n};this.getDomElement=function(){return e};this.loadThumbnail=function(){r.hide();r.attr("src",s);r.attr("alt",i)};this.visible=function(){e.trigger("visible.Slide")};this.invisible=function(){e.trigger("invisible.Slide");e.detach()};this.width=function(){return e.outerWidth(true)};this.height=function(){return e.outerHeight(true)};this.left=function(a){if(a!=null){k=a;e.css("left",a+"px")}else{k=e.position().left}return k};this.right=function(a){if(a!=null){p=a}else{p=this.left()+this.width()}return p};this.prev=function(a){if(a!=null){o=a}return o};this.next=function(a){if(a!=null){l=a}return l}}}());(function(){Ddb.ViewModels.BinaryViewer=function(h){var g=$(h);var k=$("<div><img alt='' src='/Content/themes/base/icons/loader_small.gif'/></div>").addClass("preloaderHolder");var i;var e;var f;var j=[{name:"jwplayer",types:["m4v","m4a","mp3","ogv","ogg","wav","flv"]},{name:"img",types:["gif","png","jpg"]},];this.getDomElement=function(){return g};this.getCurrentBinary=function(){return e};this.getCurrentFullSizeBinary=function(){return f?f:e};this.setBinary=function(m,q,l,o){e=q;f=l;var p=q.substr(q.lastIndexOf(".")+1).toLowerCase().replace("mp4","m4v");var n=_.find(j,function(r){return _.any(r.types,function(s){return s==p})});g.empty();if(n){switch(n.name){case"quicktime":d(q);break;case"winmedia":break;case"realplayer":break;case"jwplayer":c(p,q,o);break;case"img":b(q,m);break;case"iframe":break}}else{g.trigger("BinaryPlayError")}i=n};var d=function(l){};var c=function(n,l,m){g.append('<div id="jwplayerContainer"></div>');jwplayer("jwplayerContainer").setup({file:l,controlbar:"bottom",stretching:"uniform",width:445,height:320,image:m,skin:"/scripts/jwplayer/skin/ddbskin.zip",modes:[{type:"html5"},{type:"flash",src:"/scripts/jwplayer/player.swf"},{type:"download"}],events:{onError:function(){g.empty();g.trigger("BinaryPlayError")},onReady:function(){if($.browser.msie&&this.getRenderingMode()==="html5"){g.find("[id*='jwplayer']").each(function(){$(this).attr("unselectable","on")})}}}})};var b=function(n,l){var m=$("<img />").css({cursor:"pointer"}).load(function(o){k.remove();m.fadeIn(300)}).error(function(o){g.empty();g.trigger("BinaryPlayError")}).click(function(o){g.trigger("ShowOnModal")});m.hide();g.append(m);g.append(k);m.attr("src",n);m.attr("alt",l)};var a=function(m){var l=$("<div></div>")}}}());(function(){var a=function(c,b){return Rx.Observable.Create(function(d){amplify.request({resourceId:c,data:b,success:function(e){d.OnNext(e);d.OnCompleted()},error:function(e){d.OnError(e)}});return function(){}})};Ddb.Services.itemService={getFacetValues:function(b){return a("getObjectProperties",{id:b})},getChildren:function(b,c){return a("getObjectChildren",{id:b,includeChildId:c})},getParents:function(b){return a("getObjectParents",{id:b})}};Ddb.Services.searchService={search:function(b){return a("getSearchResults",b)},searchFacetValues:function(b){return a("getSearchFacetValues",b)}};Ddb.Services.institutionsMapService={getMapData:function(b,c,d){return a("getInstitutionMap",{clusterId:b||-1,offset:c||0,size:d||0})}}})();(function(){Ddb.ViewModels.HierarchyNode=function(a,f,g,h,d,b,i,j,e,c){var k=this;this.id=ko.observable(a||"");this.name=ko.observable(f||"");this.nodeGroups=ko.observableArray(g||[]);this.allNodes=ko.computed(function(){var l=[];_.each(k.nodeGroups(),function(m){_.each(m.nodes(),function(n){l.push(n)})});return l});this.isLeaf=ko.observable(d||false);this.isAggregationEntity=ko.observable(b||false);this.isHybrid=ko.dependentObservable(function(){return !this.isLeaf()&&!this.isAggregationEntity()},this);this.parentGroup=ko.observable(h||null);this.parent=ko.computed(function(){return k.parentGroup()?k.parentGroup().parent():null});this.isLoading=ko.observable(false);this.isExpanded=ko.observable(false);this.siblingCount=ko.observable(i||0);this.siblingCountDisplay=ko.observable(j||"");this.moreAvailable=ko.observable(e||false);this.isAppended=ko.observable(c||false);this.moreHidden=ko.computed(function(){return(k.siblingCount()>0&&k.siblingCount()>=k.allNodes().length)});this.areChildrenLoaded=ko.computed(function(){if(!k.isAggregationEntity()){return true}return k.nodeGroups().length>0});this.isLast=ko.computed(function(){if(!k.parent()){return true}if(k.parent().moreHidden()){return false}var l=k.parent().allNodes();return _.indexOf(l,k)==l.length-1});this.getChildren=function(l){k.isLoading(true);k.isExpanded(true);Ddb.Services.itemService.getChildren(this.id(),l).Subscribe(function(m,n,o){k.nodeGroups([]);_.each(m.Groups,function(p){var q=new Ddb.ViewModels.HierarchyNodeGroup(p.DisplayName,p.DisplayNamePlural,k);k.nodeGroups.push(q);q.nodes(_.map(p.Nodes,function(r){return new Ddb.ViewModels.HierarchyNode(r.Id,r.Label,[],q,r.Leaf,r.AggregationEntity,r.SiblingCount,r.SiblingCountDisplay,r.MoreAvailable,r.IsAppended)}))});k.siblingCount(m.TotalSiblingCount);k.siblingCountDisplay(m.TotalSiblingCountDisplay);k.moreAvailable(m.MoreAvailable);k.isLoading(false)})};this.hideChildren=function(){this.nodeGroups([]);this.isExpanded(false)}}})();(function(){Ddb.ViewModels.HierarchyNodeGroup=function(a,b,c){this.groupName=ko.observable(a);this.groupNamePlural=ko.observable(b);this.nodes=ko.observableArray();this.parent=ko.observable(c)}})();(function(a){Ddb.ViewModels.HierarchyViewModel=function(){var c=this;this.nodes=ko.observableArray([]);this.hierarchyRoot=ko.observable(null);this.lastExitedId=ko.observable();this.currentNode=ko.observable();this.initialPath=ko.observableArray([]);this.activePath=ko.observableArray([]);this._hasLoaded=ko.observable(true);this.hasLoaded=ko.dependentObservable(function(){return this._hasLoaded()},this);this.isVisible=ko.dependentObservable(function(){return c.hierarchyRoot()!==null},this);this.renderHierarchy=function(d){this._hasLoaded(false);Ddb.Services.itemService.getParents(d).Subscribe(function(f){if(f.length<1){c._hasLoaded(true);return}var h=_.first(f);var g=new Ddb.ViewModels.HierarchyNode(h.Id,h.Label,[],null,h.Leaf,h.AggregationEntity,h.SiblingCount,h.SiblingCountDisplay,h.MoreAvailable,h.IsAppended);var e=g;_.each(_.rest(f,1),function(k){var m=new Ddb.ViewModels.HierarchyNodeGroup(k.GroupName,k.GroupNamePlural,null);m.nodes.push(e);e.parentGroup(m);var l=new Ddb.ViewModels.HierarchyNode(k.Id,k.Label,[m],null,k.Leaf,k.AggregationEntity,k.SiblingCount,k.SiblingCountDisplay,k.MoreAvailable,k.IsAppended);m.parent(l);e=l});c.hierarchyRoot(e);if(f.length>1){var j=g;if(!j.isAggregationEntity()&&!j.isLeaf()){b(j)}else{if(j.parent()!=null){b(j.parent(),j.id())}}var i=j;while(i){c.initialPath.push(i.id());i=i.parent()}}else{b(g,null,true)}c._hasLoaded(true)})};var b=function(i,g,e){if(!i||i.isLeaf()){return false}if(!e&&i.id()===c.hierarchyRoot().id()&&(!i.moreHidden()||i.isExpanded())){return false}if(!e&&i.parent()&&(i.isExpanded()||(c.isActivePath(i.id())&&!i.moreHidden()))){i=i.parent()}if(c.currentNode()){c.currentNode().hideChildren();if(i.parent()!=c.currentNode()){c.lastExitedId(c.currentNode().id());var j=c.currentNode().parent();while(j&&j!=i){j.hideChildren();c.lastExitedId(j.id());j=j.parent()}}else{c.lastExitedId();c.currentNode().nodeGroups([i.parentGroup()]);i.parentGroup().nodes([i])}}c.activePath([]);var d=i;while(d&&d.parent()){c.activePath.push(d.id());d=d.parent()}c.currentNode(i);var f="";if(g){f=g}else{if(c.isInitialPath(i.id())){var h=_.indexOf(c.initialPath(),i.id());if(h-1>=0){f=c.initialPath()[h-1]||""}}}i.getChildren(f);return false};this.setCurrent=function(e){var d=e.currentTarget;if(!a(d).attr("href")){return b(ko.dataFor(d))}return true};this.hide=function(d){if(d.nodeType==1){a(d).fadeOut("fast",function(){})}};this.show=function(d){if(d.nodeType==1){a(d).hide();a(d).fadeIn("fast")}};this.isInitialPath=function(d){return _.contains(c.initialPath(),d)};this.isActivePath=function(d){return _.contains(c.activePath(),d)}}})(jQuery);(function(){Ddb.Pages.CultureItemPage=function(f,r,e,h,i){var u=new Ddb.ViewModels.CultureItemViewModel();var a=$(f).find(".binaryViewer");var b=a.closest(".binaryViewerContainer");var t=new Ddb.ViewModels.BinaryViewer(a);var c=$(f).find(".binaryViewerError");var d=c.find(".mediaFile");c.hide();_.each(e,function(v){var w=$("<div></div>").addClass("scroller").addClass(v.name);u.addSlideScroller(w,v.name,v.data);w.insertAfter($(f).find(".tab."+v.name));w.bind("slideSelected.SlideScroller",function(x){var y=x.slide;t.setBinary(y.getLabel(),y.getBinaryUrl(),y.getFullSizeUrl(),y.getPosterUrl());u.selectedBinary(y.getLabel())})});_.each($(f).find(".tab"),function(w){var v=$(w);if(!v.hasClass("divider")){v.data(v.next()).click(function(){var x=$(this).data().data("scroller");if(x&&x.getInitialBinary()!=null){u.currentScroller(x)}})}});t.getDomElement().bind("BinaryPlayError",function(){b.hide();c.show()}).bind("ShowOnModal",function(){$.fancybox.open({href:t.getCurrentFullSizeBinary(),title:$.trim(u.selectedBinary()),toolbar:true,padding:0,tpl:{error:'<p class="fancybox-error">'+i+"</p>",closeBtn:'<a title="'+h+'" class="fancybox-item fancybox-close" href="#"></a>',toolbarCloseBtn:'<span title="'+h+'" class="fancybox-toolbar-close" href="#"></span>'}})});u.selectedBinary.subscribe(function(w){var v=$("<a></a>");v.attr("href",t.getCurrentBinary());v.text(w);d.empty();d.append(v)});u.currentScroller.subscribe(function(v){b.show();c.hide();_.each(this.slideScrollers(),function(x){if(v==x){x.show();var w=x.getInitialBinary();if(w){t.setBinary(w.getLabel(),w.getBinaryUrl(),w.getFullSizeUrl(),w.getPosterUrl());u.selectedBinary(w.getLabel())}}else{x.hide()}});_.each($(f).find(".tab"),function(x){var w=$(x);if(!w.hasClass("divider")){if(w.data().data("scroller")==v){w.addClass("currentTab")}else{w.removeClass("currentTab")}}})},u);u.currentScroller(u.slideScrollers()[0]);ko.applyBindings(u,$(f).find(".cultureItem").get(0));var n=new Ddb.ViewModels.HierarchyViewModel();var l=$(f).find("#hierarchyViewer");n.renderHierarchy(l.attr("data-id"));var g;$("#relatedObjectsHeader span.contextualHelp").removeAttr("title").unbind("mouseover").bind("mouseover",function(){clearTimeout(g);var v=$("#relatedObjectsHeader div.tooltip");v.fadeIn();v.bind("mouseenter",function(){clearTimeout(g)}).bind("mouseleave",function(){g=setTimeout(function(){v.fadeOut()},500)})}).bind("mouseout",function(){g=setTimeout(function(){$("#relatedObjectsHeader div.tooltip").fadeOut()},3000)});var p=global.body.find(".advancedNavigationWidget");var q=p.parent();var m=l.children(".hierarchyViewer");var k=l.children("h5");var o=q.children("h5");k.addClass("selected");n.showHierarchy=function(){o.removeClass("selected");p.hide();k.addClass("selected");m.show()};q.bind("AdvancedNavigationWidgetHeaderClicked",function(){o.addClass("selected");p.show();k.removeClass("selected");m.hide()});ko.applyBindings(n,l.get(0));var s={isRelatedObjectsVisible:ko.dependentObservable(function(){return n.isVisible()}),isLoading:ko.dependentObservable(function(){return !n.isVisible()&&!n.hasLoaded()})};ko.applyBindings(s,$(f).find("#relatedObjectsHeader").get(0));ko.applyBindings(s,$(f).find(".hierarchyLoading").get(0));function j(){$(".ellipsis",l.get(0)).ellipsis()}n.currentNode.subscribe(j);n.hasLoaded.subscribe(function(v){if(v){j()}})}}());$(function(){$("body.js.start").show();var a=$("#carouselItems");if(a.length){a.carouFredSel({auto:{items:1,duration:1000,easing:"linear",pauseDuration:0}}).trigger("pause");$("#carouselPrev").hover(function(){a.trigger("configuration",["direction","right"]);a.trigger("play")},function(){a.trigger("pause")}).click(function(){return false});$("#carouselNext").hover(function(){a.trigger("configuration",["direction","left"]);a.trigger("play")},function(){a.trigger("pause")}).click(function(){return false});$(".article .caption").dotdotdot({})}});(function(a){Ddb.Pages.InstitutionItemPage=function(f,d,c){var e=ko.observable(true);ko.applyBindings({mapLoading:e},f.get(0));var b={InstitutionDetailMapReady:"InstitutionDetailMapReady",InstitutionDetailMapActivate:"InstitutionDetailMapActivate"};Ddb.Publisher.Subscribe(b.InstitutionDetailMapReady,function(i){if(i){var h=[];a(".locations .location",f).each(function(j,k){h.push({latitude:parseFloat(a(k).attr("data-lat")),longitude:parseFloat(a(k).attr("data-lon"))})});var g={language:c,mapDiv:d,position:h.length>0?h[0]:[]};e(false);Ddb.Publisher.Publish(b.InstitutionDetailMapActivate,g)}})}})(jQuery);$(function(){Ddb.Pages.InstitutionsListPage=function(h,f){var g=$("#letterFilter",h);var d=_.map(g.find("a"),function(j){return $(j).attr("href").substring(1)});var c=ko.observableArray(d);function e(){this.currentLetterFilter=ko.observable("ALL");this.isVisible=ko.observable(false);this.resultsUpdated=ko.observable(false);this.noResults=ko.observable(false);this.isLoading=ko.observable(false);this.loadingFinished=ko.computed(this.isLoading).extend({throttle:100});this.isLetterActive=function(j){return _.any(c(),function(k){return k===j})}}var i=new e();var a=$("#listview",h);var b=a.find("ul#root");ko.applyBindings(i,a.get(0));g.find("a").click(function(){var j=$(this).attr("href").substring(1);i.currentLetterFilter(j);return false});$("a",b).click(function(){if(window.location.hash&&i.isVisible()){$(window).unbind("hashchange");window.location.hash="#"+i.currentLetterFilter()}return true});i.currentLetterFilter.subscribe(function(j){i.isLoading(true);if(j==="ALL"){b.removeClass("letterFiltered");i.resultsUpdated((new Date()).getTime());return}b.addClass("letterFiltered");b.find(" > li:not(.active)#"+j).addClass("active");b.find(" > li:not(#"+j+").active").removeClass("active");i.resultsUpdated((new Date()).getTime())});f.viewType.subscribe(function(j){i.isVisible(j==="list")});f.pageQuery.subscribe(function(j){if(i.isVisible()){if(typeof j==="string"&&(/^#?([A-Z]|ALL|0-9)$/i).test(j)){i.currentLetterFilter(j.replace("#",""))}}});f.sectorData.subscribe(function(m){i.isLoading(true);if(!m||m.selected.length===0){c(d);b.removeClass("sectorFiltered");i.resultsUpdated((new Date()).getTime());return}b.addClass("sectorFiltered");b.find("li").removeClass("highlighted").removeClass("hasHighlighted");var n=_.map(m.selected,function(o){return"li:not(.highlighted)[data-sector='"+o.value+"']"}).join(", ");b.find(n).addClass("highlighted");var j=b.find(".highlighted");var k=b.find("> li.level0:not(.highlighted) li.highlighted").closest(".level0");k.addClass("hasHighlighted");var l=_.map(j,function(o){return $(o).attr("id")});c(l);i.resultsUpdated((new Date()).getTime())});i.resultsUpdated.subscribe(function(j){if(a.is(":hidden")){setTimeout(function(){i.isLoading(false)},80)}else{i.isLoading(false)}});i.loadingFinished.subscribe(function(j){var k=!j&&i.isVisible()&&b.find("> li:visible:first").length===0;i.noResults(k)})}});$(function(){Ddb.Pages.InstitutionsMapPage=function(j,e,d,c){var f={InstitutionsMapReady:"InstitutionsMapReady",InstitutionsMapRequest:"InstitutionsMapRequest",InstitutionSectorsRequest:"InstitutionSectorsRequest",InstitutionsMap:"InstitutionsMap",InstitutionSectors:"InstitutionSectors",InstitutionsMapActivate:"InstitutionsMapActivate",InstitutionsMapDeactivate:"InstitutionsMapDeactivate"};var a=$("#mapview",j);function b(){this.isVisible=ko.observable(false);this.mapLoading=ko.observable(true);this.mapIsActivated=ko.observable(false);this.lastSectorData=ko.observable()}var l=new b();ko.applyBindings(l,a.get(0));l.isVisible.subscribe(function(m){if(m){g()}else{h()}});c.viewType.subscribe(function(m){l.isVisible(m==="map")});var k=function(){Ddb.Publisher.Subscribe(f.InstitutionsMapRequest,function(m){if(!m){return}Ddb.Services.institutionsMapService.getMapData(m.clusterId,m.offset,m.size).Subscribe(function(n){if(!n){return}Ddb.Publisher.Publish(f.InstitutionsMap,n)})});Ddb.Publisher.Subscribe(f.InstitutionSectorsRequest,function(m){if(!m){return}i(c.sectorData())})};var g=function(){Ddb.Publisher.Publish(f.InstitutionsMapActivate,{mapDiv:e,language:d,sectorState:c.sectorData()});l.mapIsActivated(true)};var h=function(){l.mapIsActivated(false);Ddb.Publisher.Publish(f.InstitutionsMapDeactivate,true)};var i=function(o){if(!l.mapLoading()&&l.mapIsActivated()){var n=l.lastSectorData();if(n&&n.selected.length===o.selected.length){var m=_.difference(_.pluck(n.selected,"sector"),_.pluck(o.selected,"sector"));if(m.length===0){return}}l.lastSectorData(o);Ddb.Publisher.Publish(f.InstitutionSectors,o)}};c.sectorData.subscribe(function(m){i(m)});Ddb.Publisher.Subscribe(f.InstitutionsMapReady,function(m){if(m){l.mapLoading(false);k()}})}});$(function(){Ddb.Pages.InstitutionsPage=function(d,c,b){var e=$(".facetSelector",d);var i=$("#viewTypeSwitch",d);var j=i.find(".map, .list");function a(){this.sectorData=ko.observable();this.viewType=ko.observable();this.pageQuery=ko.observable()}var h=new a();ko.applyBindings(h,i.get(0));e.find("input").change(function(){g()});function g(){var n=_.map(e.find("input:checked"),l);var k=_.map(e.find("input:not(:checked)"),l);var m={selected:n,deselected:k};h.sectorData(m);function l(o){var p=$(o);return{sector:p.val(),value:p.attr("data-sector")}}}j.click(function(){var k=$(this).hasClass("map");h.viewType(k?"map":"list");setTimeout(function(){forceRedrawIE(i)},100)});Ddb.Pages.InstitutionsListPage(d,h);Ddb.Pages.InstitutionsMapPage(d,c,b,h);var f=function(){g();if(!window.location.hash||(/^#map$/i).test(window.location.hash)){j.filter(".map").click()}else{j.filter(".list").click()}h.pageQuery(window.location.hash)};f();if(typeof window.onhashchange!="undefined"){$(window).bind("hashchange",function(){f()})}}});(function(){if(_.isUndefined(window.ko)){return}ko.arrayHasValuesObservable=function(a){return ko.dependentObservable(function(){return ko.utils.unwrapObservable(a).length>0})};ko.bindingHandlers.dateTime={update:function(d,f,a,i){var h=ko.utils.unwrapObservable(f());var g=h.split("T");var c=g[0].split("-");var e=g[1].split(":");var b=new Date(c[0],c[1]-1,c[2],e[0],e[1],e[2]);$(d).html(b.format())}}})();Ddb.LargeCookie=(function(a,b){function c(f,e,d){this.prefix=f;this.indexCookie=f+"-n";this.limit=e||1300;this.cookieService=d||b}c.prototype.set=function(g){if(!g){this.del();return}if(g.length<=this.limit){this.del();this.cookieService.set(this.prefix+0,g);return}var d=0;var f=parseInt(this.cookieService.get(this.indexCookie),10)||0;do{var e=g.substring(0,Math.min(this.limit,g.length));this.cookieService.set(this.prefix+d,e);g=g.substring(this.limit);d++}while(g.length>0);this.cookieService.set(this.indexCookie,d-1);while(d-1<f){this.del(d++)}};c.prototype.get=function(){var e="";var d=0;var f=parseInt(this.cookieService.get(this.indexCookie))||0;do{e+=this.cookieService.get(this.prefix+d++)||""}while(d-1<f);return e};c.prototype.del=function(e){if(typeof(e)!="undefined"&&!isNaN(parseInt(e,10))){this.cookieService.del(this.prefix+e)}else{var f=parseInt(this.cookieService.get(this.indexCookie),10)||0;this.cookieService.del(this.indexCookie);for(var d=f;d>=0;d--){this.cookieService.del(this.prefix+d)}}};return c})(jQuery,jQuery.cookies);Ddb.Widget=function(b){this.Data={};var c=new Rx.CompositeDisposable();if(b){$.extend(this.Data,b.data())}this.Subscriptions=c;var a=function(){c.Dispose();delete Ddb.Widgets[b.data()["elementId"]];b.remove()};this.Dispose=a};Ddb.Widget.prototype.GetTopics=function(){return this.Data.topics.split(" ")};(function(a){a.fn.RegisterWidget=function(b){return this.each(function(){var c=a(this);var e=c.attr("data-widget");var d=this.id||"el"+new Date().getTime();if(e){c.data()["elementId"]=d;Ddb.Widgets[d]=Ddb[e]?new Ddb[e](c,b):new Ddb.Widget(c,b)}})}})(jQuery);Ddb.Services.fragmentService=(function(a){var b={beforeSend:function(d){d.setRequestHeader("Accept","application/vnd.openrasta.htmlfragment+xml")},dataType:"html",cache:false},c={};amplify.request.define("getSearchResultsFragment","ajax",a.extend(b,{url:"/searchresults/{path}"}));c.getHtmlFragment=function(d){amplify.request(d)};return c})(jQuery);Ddb.Services.historyService=(function(e){var d={};var a=e.history;var b=_.isFunction(e.history.pushState);var c=document.location.search;d.update=function(f){if(b){a.pushState(null,null,f)}c=f;return d};d.updated=function(f){var h=("state" in e.history&&e.history.state!==null);var g=location.href;$(e).bind("popstate",function(i){var j=!$.browser.mozilla&&!h;h=true;if(j){return}c=document.location.search;f(document.location.search)});return d};d.getCurrent=function(){return c};return d})(window);(function(){Ddb.ViewModels.ResultViewModel=function(b,h,e,f,d,c){var g=this;this.id=b;this.href=ko.observable(h);this.title=f.Title;this.altTitle=f.AltTitle;this.gridTitle=f.GridTitle;this.listTitle=f.ListTitle;this.previewTypes=f.PreviewTypes;this.subtitle=f.Subtitle;this.thumbnail=f.Thumbnail;this.matches=d||[];this.index=c;this.isLoadingPreview=ko.observable(false);this.isSelected=ko.observable(false);var a=function(i){return i?i.replace(/\//g,"/<wbr>"):i};this.showFacetPreview=function(i){this.isLoadingPreview(true);$(i).addClass("loading");Ddb.Services.itemService.getFacetValues(this.id).Subscribe(function(k){var j=$("<div>").append($("<h4>").html(g.title)).append("<ul>");_.each(k,function(l,m){var n=_.pluck(l.FacetValues,"DisplayName");j.children("ul").append($("<li>").html("<span class='fieldName'>"+a(l.DisplayName)+"</span> <span class='fieldContent'>"+n.join(", ")+"</span>"));$("span.fieldContent",j).addClass("truncate");if(m<_.size(k)-1){j.children("ul").append($("<li class='divider gridDivider'><hr/></li>"))}});$(i).html(j.html());g.isLoadingPreview(false);$(i).removeClass("loading")})}}})();Ddb.ViewModels.AdvancedSearchViewModel=function(){var g=this;var f=Ddb.Services.searchService;var b=Ddb.Services.historyService;this.availableRowCounts=ko.observableArray([10,20,40,60,100]);var c=20;this.offset=ko.observable(0);this.rows=ko.observable(c);this.rows.subscribe(function(i){this.offset(0)},this);var d="";this.sortType=ko.observable(d);this.sortType.subscribe(function(i){this.offset(0)},this);this.finalResponse=ko.observable();this.results=ko.observableArray([]);this.totalResults=ko.observable(0);this.paginator=new Ddb.ViewModels.Paginator();this.searchQuery=ko.observable();this.facets=ko.observableArray();this.selectedFacet=ko.observable();this.selectedFacets=ko.dependentObservable(function(){var i=[];_.each(g.facets(),function(j){if(j.hasSelectedValues()){i.push(j)}});return i},this);this.areAnyFacetsSelected=ko.dependentObservable(function(){return _.any(g.facets(),function(i){return i.hasSelectedValues()})});this._canCluster=ko.observable(false);this.isClustered=ko.observable(false);this._isClustered=ko.observable(false);this.isClusterEnabled=ko.computed({read:function(){return g._canCluster()}});this.isThumbnailFiltered=ko.observable(false);this._isThumbnailFiltered=ko.observable(false);this.isVisible=ko.observable(false);this.isLoading=ko.observable(false);this.viewType=ko.observable("list");this.isLoading.subscribe(function(i){g.paginator.isEnabled(!i)});this.facetQuery=ko.dependentObservable(function(){var i=[];var j=[];ko.utils.arrayForEach(this.facets(),function(k){var l=k.name;ko.utils.arrayForEach(k.selectedValues(),function(n){var m=l+"="+n.actualValue;if(jQuery.inArray(m,j)){j.push(m)}})});return{offset:this.offset(),rows:g.rows(),query:g.searchQuery()||"*",facetValues:j,clustered:this._isClustered(),isThumbnailFiltered:this._isThumbnailFiltered(),viewType:this.viewType(),sort:this.sortType()}},this);this.search=function(){this.facets([]);this.results([]);this.offset(0);this.showResults()};this.initFacets=function(j){var i=[];_.each(j,function(k){var l=new Ddb.ViewModels.FacetViewModel(g,k.Field,k.DisplayName);if(k.selectedValues){l.selectedValues(_.map(k.selectedValues,function(m){return new FlyoutListItem(null,null,m.field,m.displayName)}))}i.push(l)});this.facets(i)};this.updateFacets=function(i){_.each(this.facets(),function(j){j.isAvailable(_.filter(i,function(k){return(k.Field==j.name)}).length>0)})};this.onRowsChanged=function(){var i=parseInt(this.rows());if(c!=i){c=i;this.showResults()}};this.onSortTypeChanged=function(j){var i=this.sortType();if(!d){d=i}else{if(d!=i){d=i;this.showResults()}}};this.init=function(i){this.searchQuery(i.SearchQuery.SearchTerm);this.sortType(i.SearchQuery.SortType||"");c=i.SearchQuery.PageQuery.Rows;this.rows(c);this.offset(i.SearchQuery.PageQuery.Offset);this.totalResults(i.NumberOfResults);this.isClustered(i.SearchQuery.IsClustered);this.isThumbnailFiltered(i.SearchQuery.IsThumbnailFiltered);this._isClustered(i.SearchQuery.IsClustered);this._isThumbnailFiltered(i.SearchQuery.IsThumbnailFiltered);this._canCluster(i.CanCluster);if(this.availableRowCounts.indexOf(this.rows())<0){this.availableRowCounts.push(this.rows());this.availableRowCounts.sort(function(k,m){return k-m})}e(i);this.paginator.init(this.totalResults,this.rows(),this.offset());this.paginator.startIndex.subscribe(function(k){g.gotoOffset(k-1)},this);this.isClustered.subscribe(function(k){this._isClustered(k);this.showResults(false)},this);this.isThumbnailFiltered.subscribe(function(k){this._isThumbnailFiltered(k);this.showResults(false)},this);var j=_.map(i.Facets,function(k){var l=_.chain(i.SearchQuery.FacetValueRestrictions).filter(function(m){return(m.Name==k.Field)}).map(function(m){return{field:m.Value,displayName:m.DisplayName}}).value();return{Field:k.Field,DisplayName:k.DisplayName,selectedValues:l}});this.initFacets(j);this.initLanguageChangeEvents()};this.initLanguageChangeEvents=function(){Ddb.Publisher.Subscribe("LanguageChanging",function(i){if(i){Ddb.Publisher.Publish("LanguageReferrer",document.location.protocol+"//"+document.location.host+document.location.pathname+a(g.facetQuery()))}})};this.selectFacet=function(k){this.selectedFacet(k);for(var l=0;l<this.facets().length;++l){var j=this.facets()[l];if(k==j){j.isSelected(true);j.getAvailableValues()}else{j.isSelected(false)}}};var a=function(i){var j=$.param(i);var k=document.location.href.match(/searchId=(?:[a-fA-F0-9-]+)/);if(k){j+="&"+k}return"?"+j};var h=function(i){b.update(a(i))};this.updateHistoryExposed=function(i){h(this.facetQuery())};this.getFacet=function(i){return _.find(this.facets(),function(j){return j.name===i})};this.showResults=function(j,i){this.isLoading(true);if(j==true){this.facets([])}f.search(g.facetQuery()).Subscribe(function(k){if(i){i.call()}h(g.facetQuery());g.isLoading(false);if(g.facets().length==0){g.initFacets(k.Facets);g.isLoading(false)}g.updateFacets(k.Facets);g.finalResponse(k);global.results(true);e(k);g._canCluster(k.CanCluster);g.totalResults(k.NumberOfResults);g.paginator.init(g.totalResults,parseInt(g.rows(),10),g.offset())})};var e=function(i){g.results([]);_.each(i.Results,function(k){var j=new Ddb.ViewModels.Cluster(k.Name,[]);_.each(k.Docs,function(m,l){j.items.push(new Ddb.ViewModels.ResultViewModel(m.Id,m.Uri,m.Preview,m.PreviewInfo,m.View,l))});g.results.push(j)})};this.clearFilters=function(){ko.utils.arrayForEach(this.facets(),function(i){i.isSelected(false);i.selectedValues([])});this.showResults()};this.hasResults=ko.arrayHasValuesObservable(this.results);this.hasFacets=ko.arrayHasValuesObservable(this.facets);this.hasSelectedFacet=ko.dependentObservable(function(){return this.selectedFacet()!=null},this);this.gotoOffset=function(i){this.offset(i);this.showResults()};this.reloadResults=function(){this.paginator.gotoFirstPage();this.gotoOffset(0)}};(function(){Ddb.ViewModels.Cluster=function(b,a){this.name=ko.observable(b||"");this.items=ko.observableArray(a||[]);this.isOpen=ko.observable(false);this.headItem=ko.dependentObservable(function(){return this.items().length>0?this.items()[0]:null},this);this.bodyItems=ko.dependentObservable(function(){return this.items().length>1?this.items().slice(1):[]},this);this.hasOnlyOneBodyItem=ko.dependentObservable(function(){return this.bodyItems().length==1},this);this.toggleOpen=function(){this.isOpen(!this.isOpen())};this.displayUnfolded=ko.dependentObservable(function(){return this.name()==="Other Topics"||this.name().indexOf("NO_CLUSTER_")>-1},this)}})();(function(){Ddb.ViewModels.FacetPaginationViewModel=function(a,c){var d=this;this.searchService=c;this.pageSize=ko.observable(a||10);this.results=ko.observableArray();this.pageCache=ko.observableArray([]);this.numberOfFacets=ko.observable(0);this.startOffset=ko.observable(0);this.endOffset=ko.observable(this.pageSize());this.numberOfPages=ko.observable(1);this.currentPage=ko.observable(1);this.lastPagedItem=ko.observable(null);this.isLoading=ko.observable(false);this.nextPageAvailable=ko.observable(false);this.prevPageAvailable=ko.observable(false);this.selectedValues=ko.observableArray();this.facetQuery=ko.observable({});this.nextPageAvailable=ko.computed(function(){return this.currentPage()<this.numberOfPages()},this);this.prevPageAvailable=ko.computed(function(){return this.currentPage()>1},this);this.nextPage=function(){if(this.nextPageAvailable()){this.startOffset(this.currentPage()*this.pageSize());this.currentPage(this.currentPage()+1);this.search(null,1);return true}return false};this.prevPage=function(){if(this.prevPageAvailable()){this.currentPage(this.currentPage()-1);this.startOffset((this.currentPage()-1)*this.pageSize());this.search(null,-1);return true}return false};this.reset=function(){this.currentPage(1);this.startOffset(0);this.lastPagedItem(null);this.isLoading(false);this.pageCache([])};function b(h,k,i,g,f){d.isLoading(true);var j=d.pageCache();var e=d.currentPage()-1;if(g!=0&&e<j.length){d.results(j[e]);d.isLoading(false);return}c.searchFacetValues(h).Subscribe(function(o){var t=k;var p=[];var q=[];var m=d.currentPage()-1;var l=d.pageCache();if(l.length>0){q=_.flatten(l)}var u=false;var v=_.pluck(t,"actualValue");var r=_.pluck(q,"Value");var n=0;var s=0;_.each(o.FacetValues,function(w){s++;if(_.contains(v,w.Value)){return true}if(_.contains(r,w.Value)){return true}if(n++>=d.pageSize()){u=true;return false}p.push(w)});d.numberOfFacets(o.NumberOfFacets-d.selectedValues().length);d.numberOfPages(Math.ceil(d.numberOfFacets()/d.pageSize()));d.pageCache.push(p);d.results(p);d.isLoading(false);return})}this.search=function(f,e){e=parseInt(e)||0;if(e===0){this.reset()}f=_.extend(f||this.facetQuery()||{},{offset:this.startOffset(),rows:this.pageSize()+this.selectedValues().length+1});this.facetQuery(f);b(f,this.selectedValues(),this.pageSize(),e)}}})();(function(){Ddb.ViewModels.FacetViewModel=function(c,b,a){var e=this;this.NUM_VISIBLE_VALUES=10;var d=Ddb.Services.searchService;this.paginator=new Ddb.ViewModels.FacetPaginationViewModel(10,d);this.parent=c;this.name=b;this.displayName=a;this.availableValues=ko.observableArray([]);this.lastSelectedValue=ko.observable();this.lastRemovedValue=ko.observable();this.totalValues=ko.computed(function(){return this.paginator.numberOfFacets()},this);this.numberOfPages=ko.computed(function(){return this.paginator.numberOfPages()},this);this.selectedValues=ko.computed({read:function(){return e.paginator.selectedValues()},write:function(f){e.paginator.selectedValues(f||[])}});this.currentPage=ko.dependentObservable(function(){return this.paginator.currentPage()},this);this.displayCurrentPage=ko.dependentObservable(function(){return(this.paginator.currentPage()).toLocaleString()},this);this.numberOfPagesFormatted=ko.dependentObservable(function(){return this.paginator.numberOfPages().toLocaleString()},this);this.isSelected=ko.observable(false);this.isExpanded=ko.dependentObservable(function(){return this.isSelected()||this.paginator.selectedValues().length>0},this);this.isNotSelected=ko.dependentObservable(function(){return !this.isSelected()},this);this.isLoadingValues=ko.computed(function(){return this.paginator.isLoading()},this);this.isAvailable=ko.observable(true);this.isNotAvailable=ko.dependentObservable(function(){return !this.isAvailable()},this);this.isPrevPageAvailable=ko.dependentObservable(function(){return this.paginator.prevPageAvailable()},this);this.isNextPageAvailable=ko.dependentObservable(function(){return this.paginator.nextPageAvailable()},this);this.input=ko.observable("");this.throttledInput=ko.computed(this.input).extend({throttle:500});this.throttledInput.subscribe(function(){this.getAvailableValues()},this);this.lastSelectedValue.subscribe(function(f){if(f!=null){this.paginator.selectedValues.push(f)}this.paginator.reset();e.lastRemovedValue(null)},this);this.removeSelectedValue=function(){var f=this;e.removeValue(f);e.lastSelectedValue(null);e.isSelected(false);e.lastSelectedValue(null);e.lastRemovedValue(f)};this.valuesUpdated=ko.computed(function(){return this.lastRemovedValue()||this.lastSelectedValue()},this);this.throttledValuesUpdated=ko.computed(this.valuesUpdated).extend({throttle:250});this.throttledValuesUpdated.subscribe(function(){this.parent.reloadResults()},this);this.removeValue=function(f){this.paginator.selectedValues.remove(f)};this.buildFacetValueQuery=function(){var f=[];ko.utils.arrayForEach(this.parent.facets(),function(g){if(g.paginator.selectedValues().length>0&&g!=e){var h=g.name;ko.utils.arrayForEach(g.paginator.selectedValues(),function(j){var i=h+"="+j.actualValue;if(jQuery.inArray(i,f)<0){f.push(i)}})}});if(c.isThumbnailFiltered()){f.push("grid_preview=true")}return{name:this.name,searchQuery:this.parent.searchQuery()||"*",query:this.input()||"",facetValues:f}};this.paginator.results.subscribe(function(f){e.availableValues(_.map(f,function(g){return new Ddb.ViewModels.FacetValueViewModel(g.Value,g.DisplayName,g.HighlightedDisplayName,g.Count)}))});this.getAvailableValues=function(){this.paginator.reset();this.paginator.search(e.buildFacetValueQuery(this))};this.getPrevValues=function(){this.paginator.prevPage()};this.getNextValues=function(){this.paginator.nextPage()};this.beginFlyout=function(f){if(this.isExpanded()){return false}this.popupFlyout(f)};this.popupFlyout=function(f){if(this.isNotAvailable()){return}var g=$(f.currentTarget).parent()[0];this.parent.selectFacet(this);this.parent.initFlyout(g,this)};this.closeFlyout=function(g){var f=$(g.target);if(f.hasClass("valueCount")||f.closest(".valueCount").length>0){return}this.parent.selectFacet(null)};this.hasAvailableValues=ko.arrayHasValuesObservable(this.availableValues);this.hasSelectedValues=ko.arrayHasValuesObservable(this.paginator.selectedValues);this.isSelected.subscribe(function(f){this.paginator.reset()},this)}})();var Flyout=function(c,d,b,a){var e={position:"absolute"};var f=this;this.attachedTo=$(c);this.flyout=$(d);this.alignTo=$(b);this.align=a||Flyout.ALIGN_BOTTOM_LEFT;this.flyout.css(e);this.setAlign=function(g){this.align=g;this.updatePosition()};this.setPosition=function(h,g){this.flyout.css({top:h,left:g})};this.updatePosition=function(){var h,g;switch(this.align){case Flyout.ALIGN_RIGHT:h=this.alignTo.position().top;g=this.alignTo.position().left+this.alignTo.width();break;case Flyout.ALIGN_BOTTOM_RIGHT:h=this.alignTo.position().top+this.alignTo.height();g=this.alignTo.position().left+this.alignTo.width()-this.flyout.width();break;case Flyout.ALIGN_BOTTOM_CENTRE:break;case Flyout.ALIGN_BOTTOM_LEFT:default:h=this.alignTo.position().top+this.alignTo.height();g=this.alignTo.position().left;break}this.setPosition(h,g)};this.show=function(){f.updatePosition();this.flyout.fadeIn("fast")};this.hide=function(){this.flyout.fadeOut("fast")};this.flyout.hide()};Flyout.prototype.constructor=Flyout;Flyout.ALIGN_RIGHT="alignRight";Flyout.ALIGN_BOTTOM_LEFT="alignBottomLeft";Flyout.ALIGN_BOTTOM_RIGHT="alignBottomRight";Flyout.ALIGN_BOTTOM_CENTRE="alignBottomCentre";var FlyoutList=function(b,e,f,a,j,i){var c="flyout_list";var d={"float":"left",width:"250px"};var k=this;Flyout.call(this,b,e,a,Flyout.ALIGN_RIGHT);this.holder=$(f);this.numRows=j||5;this.numColumns=i||2;var g=$("<div></div>");g.addClass(c);if(this.flyout!=this.holder){this.holder.append(g)}else{this.flyout.append(g)}var h=ko.observableArray([]);this.itemList=ko.dependentObservable(function(){g.empty();var s=Math.min(Math.ceil(h().length/this.numRows),this.numColumns);var l=0;for(var n=0;n<s;++n){var m=$("<ul></ul>");m.css(d);for(var q=n*this.numRows;q<Math.min((n+1)*this.numRows,h().length);++q){var r=$("<li></li>");var o=h()[q];var p=o.domElement;p.click(function(){k.selectedItem($(this).prop("item"))}).focusin(function(){}).focusout(function(){}).mouseover(function(){k.setFocus(this)}).mouseout(function(){k.setFocus(null)});m.append(r.append(p))}m.addClass(c+"_column");if(n==0){m.addClass("first")}else{if(n==s-1){m.addClass("last")}}g.append(m);l+=m.outerWidth(true)}if(h().length==1){k.setFocus(h()[0].domElement)}g.width(l);return g},this);this.selectedItem=ko.observable();this.focusedItem=ko.observable();this.focusedIndex=ko.dependentObservable(function(){return this.focusedItem()==null?-1:ko.utils.arrayIndexOf(h(),this.focusedItem())},this);this.setItems=function(l){this.focusedItem(null);h(l)};this.removeItem=function(l){h.remove(l)};this.setFocus=function(l){$(g).find(".focused").removeClass("focused");if(l==null){this.focusedItem(null);return}if($(l).prop("item")!=null){$(l).prop("item").domElement.addClass("focused");this.focusedItem($(l).prop("item"))}};this.focusPrev=function(){var l=this.focusedIndex()-1;if(this.focusedItem()==null){if(h().length>0){this.setFocus(h()[0].domElement)}}else{if(l<0){this.attachedTo.trigger(FlyoutList.NO_MORE_PREV_ITEM)}else{this.setFocus(h()[l].domElement)}}};this.focusNext=function(){var l=this.focusedIndex()+1;if(l<h().length){this.setFocus(h()[l].domElement)}else{this.attachedTo.trigger(FlyoutList.NO_MORE_NEXT_ITEM)}};this.show=function(){this.focusedItem(null);this.flyout.fadeIn("fast");k.updatePosition()}};FlyoutList.prototype=new Flyout();FlyoutList.NO_MORE_PREV_ITEM="noMorePrevItem";FlyoutList.NO_MORE_NEXT_ITEM="noMoreNextItem";var FlyoutListItem=function(c,d,a,b){this.label=c;this.value=d;this.actualValue=a;this.displayName=b;this.domElement=$("<a></a>");this.domElement.html(this.label);this.domElement.prop("item",this);this.click=function(){this.domElement.click()}};ko.bindingHandlers.flyoutlist={init:function(c,e,a,f){var b=arguments;var d=this;setTimeout(function(){ko.bindingHandlers.flyoutlist.initFlyout.apply(d,b);e.initialized=true},0)},initFlyout:function(element,valueAccessor,allBindingsAccessor,viewModel){var options=valueAccessor()||{};var allBindings=allBindingsAccessor();var unwrap=ko.utils.unwrapObservable;var source=options.source;var modelValue=options.value;var valueProp=options.sourceValue;var labelProp=options.sourceLabel||valueProp;var displayProp=options.display||labelProp;var numRows=parseInt(options.rows)||10;var numColumns=parseInt(options.columns)||1;var flyout=(options.flyout)?eval(options.flyout.replace("this","$(element)"))[0]:$(element).parent();var holder=(options.holderSelector)?$(flyout).find(options.holderSelector)[0]:flyout;var alignTo=(options.alignTo)?eval(options.alignTo.replace("this","$(element)"))[0]:element;var maskedText=(options.maskedText)?$(element).siblings(options.maskedText)[0]:null;var flyoutList=new FlyoutList(element,flyout,holder,alignTo,numRows,numColumns);viewModel.flyoutList=flyoutList;if(options.visible!=null){if(ko.isWriteableObservable(options.visible)){if(options.visible()===false){flyoutList.hide()}options.visible.subscribe(function(newValue){if(newValue){flyoutList.show()}else{flyoutList.hide()}})}else{if(options.visible==false){flyoutList.hide()}else{}}}else{}var mappedSource=ko.dependentObservable(function(){var mapped=ko.utils.arrayMap(unwrap(source),function(item){var result=new FlyoutListItem((labelProp?unwrap(item[labelProp]):unwrap(item).toString()),(displayProp?unwrap(item[displayProp]):unwrap(item).toString()),(actualValue=valueProp?unwrap(item[valueProp]):item),item.displayName);return result});flyoutList.setItems(mapped);flyoutList.updatePosition();return mapped},null,{disposeWhenNodeIsRemoved:element});flyoutList.focusedItem.subscribe(function(newValue){if(maskedText!=null){$(maskedText).text(newValue!=null?newValue.value:"")}});flyoutList.selectedItem.subscribe(function(newValue){writeValueToModel(newValue)});var writeValueToModel=function(valueToWrite){if(ko.isWriteableObservable(modelValue)){modelValue(valueToWrite)}else{if(allBindings._ko_property_writers&&allBindings._ko_property_writers["jqAutoValue"]){allBindings._ko_property_writers["jqAutoValue"](valueToWrite)}}};$(flyout).click(function(event){$(element).focus()});$(element).keyup(function(event){event.preventDefault();if(event.keyCode==13){if(flyoutList.focusedItem()==null){return}flyoutList.focusedItem().click()}}).keydown(function(event){if(event.keyCode==38){event.preventDefault();flyoutList.focusPrev()}else{if(event.keyCode==40){event.preventDefault();flyoutList.focusNext()}}})},update:function(c,f,b,g){if(!f.initialized){return}var d=f()||{};var a=b();var e=ko.utils.unwrapObservable;g.flyoutList.updatePosition()}};var Global=function(){var a=this;this.window=$(window);this.body=$("body");this.start=ko.observable(a.body.hasClass("start"));this.results=ko.observable(a.body.hasClass("results"));this.object=ko.observable(a.body.hasClass("object"));this.isMapLoaded=false;this.resultsMode=ko.observable("list");this.scrollMode=ko.observable("paginator");this.isShowingModal=false;this.scrollPosition=ko.observable(a.window.scrollTop());this.viewPortWidth=ko.observable(a.window.width()).extend({throttle:200});this.viewPortHeight=ko.observable(a.window.height()).extend({throttle:200});$(window).bind("scroll",function(b){a.scrollPosition(b.currentTarget.scrollY)}).bind("resize",function(b){a.viewPortWidth(b.currentTarget.innerWidth);a.viewPortHeight(b.currentTarget.innerHeight)});this.start.subscribe(function(b){if(!b){a.body.removeClass("start")}else{a.body.addClass("start")}});this.results.subscribe(function(b){if(!b){a.body.removeClass("results")}else{a.body.addClass("results")}});this.object.subscribe(function(b){if(!b){a.body.removeClass("object")}else{a.body.addClass("object");$.scrollTo(0,0)}});this.resultsMode.subscribe(function(b){switch(b){case"list":a.body.find("div.mapResults").hide();a.body.find("div.listResults").show();break;case"map":a.body.find("div.mapResults").show();a.body.find("div.listResults").hide();break}});this.scrollMode.subscribe(function(b){switch(b){case"paginator":a.body.removeClass("infiniteScrollMode");break;case"infinite":a.body.addClass("infiniteScrollMode");break}})};Ddb.ViewModels.InstitutionListViewModel=function(a,b){this.name=ko.observable(a);this.isSelected=ko.observable(!!b)};Ddb.ViewModels.InstitutionSectorViewModel=function(a,b){this.name=ko.observable(a);this.isSelected=ko.observable(!!b)};var ObjectBinariesItem=function(b,c,d){var a=b.data();var e=this;this.name=a.name;this.uri=b.find("a").attr("href");this.elementReference=b;this.type=ko.observable(a.type);this.typeMessage=ko.observable();this.typeGroup=ko.observable();this.isSelected=ko.observable(false);this.naturalWidth=ko.observable(0);this.naturalHeight=ko.observable(0);this.ratio=ko.dependentObservable({read:function(){if(!e.naturalWidth()&&!e.naturalHeight()){return 1}var g=(e.naturalWidth())?(e.naturalWidth()/d.contentWidth()).toFixed(3):1;var f=(e.naturalHeight())?(e.naturalHeight()/d.contentHeight()).toFixed(3):1;return(f>g)?f:g}});this.displayWidth=ko.dependentObservable({read:function(){return Math.round(e.naturalWidth()/e.ratio())}});this.displayHeight=ko.dependentObservable({read:function(){return Math.round(e.naturalHeight()/e.ratio())}});this.isPlayable=ko.dependentObservable({read:function(){var h=e.type().split("/");var g=false;var j;var i;switch(h[0]){case"image":j="image";i="image";break;case"application":switch(h[1]){case"pdf":j="a PDF";i="download";break;case"octet-stream":var f=e.uri.split(".").pop();switch(f){case"m4a":j=f;i="audio";g=true;break;case"ogv":j=f;i="video";g=true;break;case"ogg":j="oga";i="audio";g=true;break;case"mp4":j="m4v";i="video";g=true;break;default:j="an octet stream we can't handle";i="download"}break;case"x-shockwave-flash":j="a Flash file";i="download";break;default:j="application we can't handle: "+h[1];i="download"}break;case"audio":switch(h[1]){case"wav":j="wav";g=true;break;case"mpeg":j="mp3";g=true;break;default:j="audio we can't handle: "+h[1]}i="audio";break;case"video":switch(h[1]){case"avi":j="avi";break;case"quicktime":j="mov";break;case"mpeg":j="mpeg";g=true;break;default:j="video we can't handle: "+h[1]}i="video";break;default:j="something else we don't know how to handle: "+e.type();i="download"}e.typeMessage(j);e.typeGroup(i);if(!c.typeGroup()){c.typeGroup(i)}return g}});this.setNaturalSize=function(g,f){this.naturalWidth(g);this.naturalHeight(f)}};var ObjectBinariesCarouselItem=function(b,c){var a=b.data();var d=this;this.name=a.name;this.uri=b.find("a").attr("href");this.key=this.uri?this.uri.split("/").pop().split(".")[0]:"";this.elementReference=ko.observable();this.typeGroup=ko.observable();this.isSelected=ko.observable(false);this.playableItems=ko.observable(0);this.itemsObservables=ko.observableArray();this.addItem=function(e){if(e){d.itemsObservables().push(new ObjectBinariesItem(e,d,c));if(d.itemsObservables()[d.itemsObservables().length-1].isPlayable()){d.playableItems(d.playableItems()+1)}}};if(b){this.addItem(b)}if(c.carouselItems){c.carouselItems[this.key]=this}};var ScrollableArea=function(){var a=this;this.scrollThreshold=ko.observable(0);this.scrollOffset=ko.observable(0);this.scrollOffsetPadding=ko.observable(0);this.contentSize=ko.observable(0);this.scrollValue=ko.observable(0);this.scrollInitTo=ko.observable("right");this.scrollClickStep=ko.observable(200);this.selectedOffLeft=ko.observable(false);this.selectedOffRight=ko.observable(false);this.measureContent=null;this.positionContent=null;this.recalculateScrollValue=null;this.isScrollable=ko.dependentObservable({read:function(){if(a.contentSize()>a.scrollThreshold()){a.scrollValue((a.scrollInitTo()=="right")?a.scrollThreshold()-a.contentSize():0);return true}else{a.scrollValue(0);return false}}});this.calculatedScrollValue=ko.dependentObservable({read:function(){var b=a.scrollValue()-(a.scrollOffset()+a.scrollOffsetPadding());return(a.isScrollable())?b:0},write:function(c){var b=c+a.scrollOffset()+a.scrollOffsetPadding();a.scrollValue(b)}});this.calculatedScrollValue.subscribe(function(b){if(a.positionContent){a.positionContent(b)}});this.canScrollLeft=ko.dependentObservable({read:function(){return(a.isScrollable())?(a.calculatedScrollValue()!=a.scrollOffset()):false}});this.canScrollRight=ko.dependentObservable({read:function(){var b=a.scrollThreshold()-a.contentSize();return(a.isScrollable())?(a.scrollValue()!=b):false}});this.scrollContent=function(c){var b=c.target.getAttribute("data-direction");var f;if(b=="left"){f=a.calculatedScrollValue()+a.scrollClickStep();if(f>a.scrollOffset()){f=a.scrollOffset()}}else{if(b=="right"){f=a.calculatedScrollValue()-a.scrollClickStep();var d=a.scrollThreshold()-(a.contentSize()+a.scrollOffset()+a.scrollOffsetPadding());if(f<d){f=d}}else{f=a.calculatedScrollValue()}}a.calculatedScrollValue(f);c.preventDefault()}};var ObjectBinariesDisplay=function(){var a=this;this.scrollable=new ScrollableArea();this.contentWidth=ko.observable(0);this.contentHeight=ko.observable(0);this.contentWidthPx=ko.dependentObservable({read:function(){return a.contentWidth()+"px"}});this.contentHeightPx=ko.dependentObservable({read:function(){return a.contentHeight()+"px"}});this.maxWidth=0;this.maxHeight=0;this.filenameKeys={};this.carouselItemsObservable=ko.observableArray();this.carouselItems={};this.updateVisibleItem=null;this.measureController=null;this.toModal=null;this.contentLoaded=ko.observable(false);this.contentLoaded.subscribe(function(b){if(!b){return}if(a.carouselItemsObservable().length>0){a.selectedItem(0)}if(a.measureController){a.measureController()}a.scrollable.contentSize(a.scrollable.measureContent())});this.selectedItem=ko.observable();this.selectedItem.subscribe(function(c){var b=a.carouselItemsObservable()[c];ko.utils.arrayForEach(a.carouselItemsObservable(),function(d){d.isSelected(d==b)});if(a.contentLoaded()){a.updateVisibleItem()}});this.init=function(c,d){var b=c.find("li[data-name=binaries]");b.each(function(){$(this).find("div.item").each(function(){var e=$(this);var f=e.find("a").attr("href").split("/").pop().split(".")[0];if(!a.filenameKeys[f]){a.filenameKeys[f]=1;a.carouselItemsObservable().push(new ObjectBinariesCarouselItem(e,a))}else{a.filenameKeys[f]++;a.carouselItems[f].addItem(e)}})});if(d){a.contentWidth(d.contentWidth);a.contentHeight(d.contentHeight);a.maxWidth=d.maxWidth;a.maxHeight=d.maxHeight}};this.setSelectedItemFromController=function(b){var c=$(b.target).closest("li");a.selectedItem(c.index());b.preventDefault()};this.reset=function(){}};Ddb.ViewModels.Paginator=function(b,a,d){var e=this;this.isEnabled=ko.observable(true);this.totalItems=ko.observable(0);this.totalItemsFormatted=ko.dependentObservable(function(){return this.totalItems().toLocaleString()},this);this.itemsPerPage=ko.observable(0);this._startIndex=ko.observable(0);this.startIndex=ko.dependentObservable(function(){return this._startIndex()+1},this);this.startIndexFormatted=ko.dependentObservable(function(){return this.startIndex().toLocaleString()},this);this.endIndex=ko.dependentObservable(function(){return Math.min(this._startIndex()+this.itemsPerPage(),this.totalItems())},this);this.endIndexFormatted=ko.dependentObservable(function(){return this.endIndex().toLocaleString()},this);this._currentPage=ko.dependentObservable(function(){return Math.floor(this.startIndex()/this.itemsPerPage())},this);this.currentPage=ko.dependentObservable(function(){return this._currentPage()+1},this);this.currentPageFormatted=ko.dependentObservable(function(){return this.currentPage().toLocaleString()},this);this._totalPages=ko.dependentObservable(function(){return Math.ceil(this.totalItems()/this.itemsPerPage())-1},this);this.totalPages=ko.dependentObservable(function(){return this._totalPages()+1},this);this.totalPagesFormatted=ko.dependentObservable(function(){return Math.max(this.totalPages(),1).toLocaleString()},this);this.hasPrevPage=ko.dependentObservable(function(){return this._startIndex()>0},this);this.hasNextPage=ko.dependentObservable(function(){return this._currentPage()<this._totalPages()},this);this.init=function(g,f,h){if(g==null||typeof g=="number"){this.totalItems(g||0)}else{if(g instanceof Array){this.totalItems(g.length)}else{if(ko.isObservable(g)){if(g() instanceof Array){this.totalItems=ko.dependentObservable(function(){return g().length},this)}else{this.totalItems=ko.dependentObservable(function(){return ko.utils.unwrapObservable(g)},this)}}}}this.itemsPerPage(f||0);this._startIndex(h||0);this.totalItemsFormatted=ko.dependentObservable(function(){return this.totalItems().toLocaleString()},this)};var c=function(){$("html, body").animate({scrollTop:0},0)};this.gotoPrevPage=function(f){if(e.isEnabled()&&e.hasPrevPage()){e._startIndex(e._startIndex()-e.itemsPerPage());if(f){c()}}};this.gotoNextPage=function(f){if(e.isEnabled()&&e.hasNextPage()){e._startIndex(e._startIndex()+e.itemsPerPage());if(f){c()}}};this.gotoFirstPage=function(f){if(e.isEnabled()){e._startIndex(0);if(f){c()}}};this.gotoLastPage=function(f){if(e.isEnabled()){e._startIndex(e._totalPages()*e.itemsPerPage());if(f){c()}}};this.init(b,a,d)};Ddb.ViewModels.SearchQueryViewModel=function(){var b=this;var a="ddbquery";this.searchTerm=ko.observable();this.refresh=function(){var e=document.location.href.match(/query=(?:[^&#]*)/);if(e){var d=e[0].split("=")[1];if(d.length>0){var c=escape(decodeURIComponent((d).replace(/\+/g,"%20")));$.cookies.set(a,c)}else{$.cookies.del(a)}}else{$.cookies.del(a)}this.init()};this.init=function(){var c=$.cookies.get(a);if(c!=undefined){b.searchTerm(unescape(c))}else{$.cookies.del(a);b.searchTerm("")}}};var ThirdParty=function(){this.isLoading=ko.observable(true)};var Tooltip=function(a){var b=this;this.tooltipWidth=ko.observable(200);this.tooltipHeight=ko.observable(100);this.x=ko.observable();this.y=ko.observable();this.xOffset=ko.observable(0);this.yOffset=ko.observable(0);this.positionMode=ko.observable("absolute");this.layout=ko.observable("top");this.isVisible=ko.observable(false);this.content=ko.observable();this.requiredIframe=null;this.measureTooltip=null;this.xpx=ko.dependentObservable({read:function(){return b.x()+"px"}});this.ypx=ko.dependentObservable({read:function(){return b.y()+"px"}});this.calculateFixedPosition=function(c){var e=parseInt(c.css("margin-top"));var d=function(f){e+=f.position().top;if(f.offsetParent().css("position")!="fixed"){d(f.offsetParent())}};d(c);return e};this.update=function(c){if(c){var d;if(this.requiredIframe){d={l:(($(window).width()-($(window).width()-(this.requiredIframe.offset().left+this.requiredIframe.width())))-(this.requiredIframe.width()-c.target.offset().left)),t:(c.target.offset().top+((this.requiredIframe.height()/2)-c.target.height())),w:c.target.width(),h:c.target.height()};this.requiredIframe=null}else{d={l:c.target.offset().left,t:c.target.offset().top,w:c.target.width(),h:c.target.height()}}if(c.withinFixed){var e=this.calculateFixedPosition(c.target);d.t=e}b.content(c.content);if(c.withinFixed){b.positionMode("fixed")}if(c.layout){b.layout(c.layout)}else{b.layout("top")}b.measureTooltip();b.positionTooltip(d);b.isVisible(true)}else{b.isVisible(false);b.positionMode("absolute")}};this.positionTooltip=function(c){if(!c){c={l:0,t:0,w:16,h:16}}if(b.layout()=="right"){b.y(c.t-b.yOffset());b.x(c.l+c.w-b.xOffset())}else{b.y(c.t+c.h-b.yOffset());b.x(c.l+(c.w/2)-(b.tooltipWidth()/2))}};this.positionTooltip();a.viewPortWidth.subscribe(function(){b.positionTooltip()});a.viewPortHeight.subscribe(function(){b.positionTooltip()})};Ddb.startAdvancedSearchHistory=function(a,b){var c=function(d){$(b).html("");Ddb.Services.fragmentService.getHtmlFragment({resourceId:"getSearchResultsFragment",data:{path:d},success:function(e){$(a).html(e);Ddb.initializeAdvancedSearch($(b).get(0))}})};Ddb.Services.historyService.updated(c)};Ddb.startLastSearchPersist=function(b,a){var c;$(b).live("click",function(){c=true});$(window).bind("beforeunload",function(){if(c){$.cookies.set(a,Ddb.Services.historyService.getCurrent())}else{$.cookies.del(a)}})};Ddb.initializeAdvancedSearch=function(a){if(!(a&&a.nodeType==1)){return}var b=new Ddb.ViewModels.AdvancedSearchViewModel();b.hideMainloader=function(){$(a).parent().children("img.loader").hide()};b.clearSelectedFacet=function(){b.selectFacet(null)};b.initFlyout=function(j,k){var l=$(j).children("a")[0];var n=$(j).find("input")[0];var i=$(j).children(".addMoreFilters")[0];n.focus();$(n).on("keydown.AdvancedSearchWidget",function(o){if(o.keyCode==27){b.selectFacet(null);m(k,l,i)}});$(n).on("keyup.AdvancedSearchWidget",function(o){if(k.input().length!=$(this).val().length){k.input($(this).val())}});$(n).live(FlyoutList.NO_MORE_PREV_ITEM,function(){k.getPrevValues()}).live(FlyoutList.NO_MORE_NEXT_ITEM,function(){k.getNextValues()});$("body").on("mouseup.AdvancedSearchWidget",function(o){if(j!==o.target&&$(j).has(o.target).length==0){b.selectFacet(null)}});k.selectedValues.subscribe(function(o){b.selectFacet(null);m(k,l,i)},k);k.isSelected.subscribe(function(o){if(!o){$("body").off("mouseup.AdvancedSearchWidget");$(n).off("keyup.AdvancedSearchWidget");$(n).off("keydown.AdvancedSearchWidget");this.input("")}},k);var m=function(p,q,o){if(p.selectedValues().length>0){}else{if(b.selectedFacet()==null){$(q).focus()}}}};b.isListView=ko.observable(true);b.isGridView=ko.observable(false);b.isGridRow=function(i,j){return(b.isGridView()&&((ko.utils.arrayIndexOf(i.items,j)==i.items().length-1&&ko.utils.arrayIndexOf(i.items,j)%4!=3)||(ko.utils.arrayIndexOf(i.items,j)%4==3&&ko.utils.arrayIndexOf(i.items,j)>1)))};$(a).find("#resultsWrapper").show();var f=$(a).find(".searchResults");b.switchToGridView=function(i,j){if(this.isClustered()){this.isClustered(false);this.showResults()}this.viewType("grid");f.addClass("gridView");f.show();if(!j){this.updateHistoryExposed()}if(i&&i.currentTarget){forceRedrawIE($(i.currentTarget).parent())}};b.switchToListView=function(i,j){this.viewType("list");this.isClustered(false);f.removeClass("gridView");f.show();if(!j){this.updateHistoryExposed()}if(i&&i.currentTarget){forceRedrawIE($(i.currentTarget).parent())}};b.viewType.subscribe(function(i){switch(i){case"list":this.isListView(true);this.isGridView(false);break;case"grid":this.isListView(false);this.isGridView(true);break}},b);var h=document.location.href.match(/viewType=(?:[a-zA-Z]+)/);if(h){h=h[0].split("=")[1];if(h=="grid"){b.switchToGridView(null,true)}else{b.switchToListView(null,true)}}else{b.switchToListView(null,true)}b.isListResultsVisible=ko.dependentObservable(function(){return this.hasResults()},b);b.init(data);$(".facetResults").show();var e=null;var g=function(){var j;if($(this).data("flyout")==null){var l=$("<div class='flyoutWrapper'/>");$(this).wrap(l);var i=$("<div class='flyoutAlign' />");i.insertAfter($(this));var k=$("<div class='flyout'/>");k.insertAfter(i);j=new Flyout(this,k,i,Flyout.ALIGN_BOTTOM_RIGHT);$(this).data("flyout",j);var n=ko.dataFor(this);if(n instanceof Ddb.ViewModels.Cluster){n.headItem().showFacetPreview(k)}else{n.showFacetPreview(k)}f.find("div.flyoutWrapper").on("mouseleave",c)}$(this).addClass("active");j=$(this).data("flyout");if(f.hasClass("gridView")){var n=ko.dataFor(this);var m=b.results()[0].items.indexOf(n);if(m%4<2){j.setAlign(Flyout.ALIGN_BOTTOM_LEFT)}else{j.setAlign(Flyout.ALIGN_BOTTOM_RIGHT)}}else{j.setAlign(Flyout.ALIGN_BOTTOM_RIGHT)}if(e){e.css("z-index",0)}$(this).parents("li").css("z-index",1);e=$(this).parents("li");j.show()};var c=function(){var i=$(this).find("div.information").removeClass("active").data("flyout");if(i==null){return}i.hide()};var d=function(){$(".facetResults .contextualHelp").removeAttr("title").unbind("mouseover").bind("mouseover",function(){var i=$(this);var j=false;Ddb.Publisher.Publish("TooltipContent",{content:this.getAttribute("data-content"),target:i,withinFixed:j})}).bind("mouseout",function(i){if(!$(i.toElement).hasClass("tooltip")){Ddb.Publisher.Publish("TooltipContent")}})};d();b.initPreview=function(){var i;f.find("div.thumbnail, div.information").on("mouseenter",function(){if(i){clearTimeout(i);i=null}var j=$(this).closest(".item").find("div.information").get(0);i=setTimeout(function(){g.call(j)},250)});f.find("div.thumbnail, div.information").on("mouseleave",function(){if(i){clearTimeout(i);i=null}c.call($(this).closest(".item").get(0))})};b.initPreview();b.mouseOverFacetItem=function(i){$(i.currentTarget).parent().removeClass("mouseout")};b.mouseOutFacetItem=function(i){$(i.currentTarget).parent().addClass("mouseout")};ko.applyBindings(b,a)};Ddb.LanguageWidget=function(a){Ddb.Widget.call(this,a);if(!a.closest("header").length){return false}var c=a.find("form select option");var b=$('<ul class="selector"></ul>');var e={right:0,top:14};var d=a.find("form select option:selected")[0];b.append('<li data-language="'+$(d).val()+'" class="selected">'+$(d).text()+"</li>");c.each(function(){if(this!=d){b.append('<li data-language="'+this.value+'">'+$(this).text()+"</li>")}});a.append(b);b.bind("click",function(f){if(f.target.nodeName.toLowerCase()=="li"&&f.target.className.indexOf("selected")==-1){var g=a.find("form");g.find("select").val(f.target.getAttribute("data-language"));g.find("input[type=hidden]").val(document.location.href);Ddb.Publisher.Publish("LanguageChanging",true);g.submit()}}).bind("mouseout",function(f){if(!$(f.relatedTarget).closest("ul.selector").length){$(this).fadeOut("fast")}});this.Subscriptions.Add(Ddb.Publisher.Get("ShowLanguageSelector").Subscribe(function(f){if(f){b.fadeIn("fast")}}));this.Subscriptions.Add(Ddb.Publisher.Get("LanguageSelectorPosition").Skip(1).Subscribe(function(f){if(f){var g=parseInt(b.css("padding-left"))-parseInt(f.css("padding-left"));var h=parseInt(b.css("padding-top"))-parseInt(f.css("padding-top"))+parseInt(b.css("border-top-width"))}}));this.Subscriptions.Add(Ddb.Publisher.Get("LanguageReferrer").Subscribe(function(f){if(f){a.find("form input[type=hidden]").val(f)}}));return this};Ddb.LanguageWidget.prototype=new Ddb.Widget();Ddb.MediaPlayerWidget=function(a){Ddb.Widget.call(this,a);var j=mediaUrl.split("|");var e=mimeType.split("|");var h=fallbackPlayerPage;var d={};$.each(e,function(k,l){d[l]=j[k]});var c=$("div.jp-jplayer");var g="jplayer_"+c.length;var b="jp_interface_"+c.length;var f=a.find("div.jp-jplayer").attr("id",g);a.find("div.jp-interface").attr("id",b);f.jPlayer({swfPath:"/Scripts/JQuery/JPlayer/js",solution:"flash,html",supplied:e.join(","),volume:0.5,cssSelectorAncestor:"#"+b,ready:function(){$(this).jPlayer("setMedia",d)},error:function(k){$(this).jPlayer("destroy");a.find("div.jp-audio").remove();a.html(i(k.jPlayer.error));a.closest("div.wrapper").addClass("noData")}});function i(l){var k=encodeURIComponent(j);var m='<div class="jp-audio-error"><p>We could not play the requested media file. You can try:</p><ul><li><a href="'+h+"?url="+k+"&mimetype="+mimeType+'">Open the mediaplayer in a new page</a></li>';$.each(j,function(){m+='<li><a href="'+this+'">Download: '+this.split("/").pop()+"</a></li>"});m+="<li>Use an alternative web browser</li></ul><small>Error code: "+l.type+" with message: "+l.message+"</small></div>";return m}};Ddb.MediaPlayerWidget.prototype=new Ddb.Widget();Ddb.NavigationWidget=function(b){Ddb.Widget.call(this,b);var a=b.find("ul.navigation ul");c();b.find("ul.navigation li").unbind("mouseover").bind("mouseover",function(){var e=$(this);a.hide();e.find("ul").show()});$(window).bind("beforeunload",function(){b.closest("header").unbind("mouseout")});b.unbind("mouseout").closest("header").bind("mouseout",function(f){if(f.target.nodeName.toLowerCase()=="header"&&!($(f.relatedTarget).closest("header").length)){if(b.find("ul.navigation li.active ul").length){c()}else{a.fadeOut("fast")}}});function c(){a.each(function(){var e=$(this);var f=e.closest("li");if(e.find("li.active").length>0||(f.hasClass("active")&&!f.hasClass("root"))){setTimeout(function(){e.fadeIn(500)},150)}else{e.fadeOut(200)}})}var d=b.find("li.language");d.unbind("click").bind("click",function(f){Ddb.Publisher.Publish("LanguageSelectorPosition",d);Ddb.Publisher.Publish("ShowLanguageSelector",true);f.preventDefault()})};Ddb.NavigationWidget.prototype=new Ddb.Widget();Ddb.ObjectBinariesDisplayWidget=function(b){alert("Got to here.");Ddb.Widget.call(this,b);var a=b.find("ul;.carousel");var f=new ObjectBinariesDisplay();var d=b.find("div.controllerContainer ul");var e={left:b.find("div.view button[data-direction=left]"),right:b.find("div.view button[data-direction=right]")};f.toModal=function(g){var h=$(g.target).closest("li.item");if(!h.hasClass("image")){return true}var j=h.find("div.wrapper img").attr("data-fullsrc");var i=h.find("span.caption").text();Ddb.Publisher.Publish("ShowInModal",{image:j,title:i});if(g){g.preventDefault()}};f.scrollable.scrollThreshold(parseInt(b.find("div.controllerContainer").width()));f.scrollable.scrollOffset(0);f.scrollable.scrollOffsetPadding(0);f.scrollable.scrollInitTo("left");f.scrollable.scrollClickStep(436);f.scrollable.measureContent=function(){var g=0;d.find("li").each(function(){var h=$(this);g+=h.width()});d.width(g);return d.width()};f.scrollable.positionContent=function(g){d.animate({left:g})};f.scrollable.recalculateScrollValue=function(g){if(!f.scrollable.isScrollable()){return f.scrollable.calculatedScrollValue()}var n=$(g).closest("li");var m=n.offset();var i=e.left.offset().left+e.left.width();var l=e.right.offset().left;var h=i-m.left;var k=m.left+n.width()+parseInt(n.css("margin-right"))-l;var j;if(h>0){j=f.scrollable.calculatedScrollValue()+(f.scrollable.scrollOffset()+f.scrollable.scrollOffsetPadding()+h);if(j>e.left.width()){j=e.left.width()}}else{if(k>0){j=f.scrollable.calculatedScrollValue()-(k+f.scrollable.scrollOffsetPadding())}else{j=f.scrollable.calculatedScrollValue()}}return j};var c=function(l,g){var k=0;var j=l.length;var h={largestImg:{width:0,height:0}};var i=function(){k++;if(k==j&&g){h.largestImg.width=(h.largestImg.width==0)?f.contentWidth():h.largestImg.width;h.largestImg.height=(h.largestImg.height==0)?f.contentHeight():h.largestImg.height;g(h)}};$.each(l,function(){var p=this;var s=p.typeGroup();var n=b.find('div.carouselContainer li[data-key="'+p.key+'"]');p.elementReference(n);if(p.playableItems()){var q=[];var r=[];$.each(p.itemsObservables(),function(){if(this.isPlayable()){q.push(encodeURIComponent(this.uri));r.push(this.typeMessage())}});Ddb.Funcs.InsertWidget(p.elementReference().find("div.wrapper"),Ddb.siteRoot+"mediaplayer?url="+q.join("|")+"&mimetype="+r.join("|"),function(){if(p.elementReference().find("div.jp-audio-error").length){p.elementReference().find("div.wrapper").addClass("mediaError")}i()})}else{var m;if(s=="image"){var o=p.itemsObservables()[0];m=$("<img />");m.attr("alt",o.name);m.one("load",function(){var t=$(this);var u={width:t.width(),height:t.height()};o.setNaturalSize(u.width,u.height);if(u.width>h.largestImg.width){h.largestImg.width=u.width}if(u.height>h.largestImg.height){h.largestImg.height=u.height}t.closest("div.wrapper").attr("title","original size "+u.width+"px x "+u.height+"px");i()});p.elementReference().find("div.wrapper").append(m);m.attr("src",o.uri);m.data("fullsrc",o.full_uri)}else{m=$('<div class="imgEquiv"><p>We could not display this content: '+p.itemsObservables()[0].typeMessage()+"</p></div>");p.elementReference().find("div.wrapper").addClass("noData").append(m);i()}}})};f.updateVisibleItem=function(){var g=f.carouselItemsObservable()[f.selectedItem()];g.elementReference().find("img").css({"max-width":g.itemsObservables()[0].displayWidth()+"px","max-height":g.itemsObservables()[0].displayHeight()+"px"});g.elementReference().show()};f.measureController=function(){var g=0;b.find("ul.controller li").each(function(){g+=$(this).width()});if(g){b.find("ul.controller").width(g)}};f.init(a,{contentWidth:497,contentHeight:280,maxWidth:497,maxHeight:497});ko.applyBindings(f,b.get(0));c(f.carouselItemsObservable(),function(g){var h=(g.largestImg.width>g.largestImg.height)?"landscape":"portrait";if(h=="portrait"){var i=g.largestImg.width/f.maxWidth;var j=parseInt(g.largestImg.height/i);if(j>f.maxHeight){j=f.maxHeight}f.contentHeight(j)}f.contentLoaded(true);f.measureController()});f.scrollable.contentSize(f.scrollable.measureContent())};Ddb.ObjectBinariesDisplayWidget.prototype=new Ddb.Widget();Ddb.SearchQueryWidget=function(a){if(global.start()){var b;a.find("span.contextualHelp").removeAttr("title").unbind("mouseover").bind("mouseover",function(){clearTimeout(b);var d=a.find("div.tooltip");d.fadeIn();d.bind("mouseenter",function(){clearTimeout(b)}).bind("mouseleave",function(){b=setTimeout(function(){d.fadeOut()},500)})}).bind("mouseout",function(){b=setTimeout(function(){a.find("div.tooltip").fadeOut()},3000)});$("input.query",a).focus()}else{var c=new Ddb.ViewModels.SearchQueryViewModel();c.init();Ddb.Publisher.Subscribe("RefreshSearchQuery",function(d){if(d){c.refresh()}});ko.applyBindings(c,a.get(0));a.find("span.contextualHelp").removeAttr("title").unbind("mouseover").bind("mouseover",function(){var d=$(this);var e=false;Ddb.Publisher.Publish("TooltipContent",{content:this.getAttribute("data-content"),target:d,withinFixed:e})}).bind("mouseout",function(d){if(!$(d.toElement).hasClass("tooltip")){Ddb.Publisher.Publish("TooltipContent")}})}};Ddb.SearchQueryWidget.prototype=new Ddb.Widget();Ddb.ThirdPartyWidget=function(a){var b=this;this.viewModel=new ThirdParty();ko.applyBindings(this.viewModel,a.get(0));Ddb.Widget.call(this,a);Ddb.WindowToMessage=a.find("iFrame").get(0).contentWindow;Ddb.Publisher.Subscribe("SetIFrameSize",function(c){if(c){a.find("iFrame").height(c.height).width(c.width)}});Ddb.Publisher.Subscribe("WidgetLoaded",function(c){if(c&&c==Ddb.WindowToMessage.name){b.viewModel.isLoading(false)}})};Ddb.ThirdPartyWidget.prototype=new Ddb.Widget();Ddb.TooltipWidget=function(b){var f=new Tooltip(global);f.measureTooltip=function(){f.tooltipWidth(b.width());f.tooltipHeight(b.height())};var a=3;var e=null;var c=0;var d=0;ko.applyBindings(f,b.get(0));Ddb.Widget.call(this,b);Ddb.Publisher.Get("TooltipContent").Skip(1).Subscribe(function(g){e=g;if(g){f.update(g);$(document).bind("mousemove.Tooltip",function(h){c=h.pageX;d=h.pageY;if((c<f.x()-a||d<f.y()-a||c>f.x()+f.tooltipWidth()+a||d>f.y()+f.tooltipHeight()+a)&&!e){f.update(null);$(document).unbind("mousemove.Tooltip")}})}});b.bind("mouseout",function(g){var h=$(g.toElement);if(!h.closest("div.tooltip").length){Ddb.Publisher.Publish("TooltipContent")}})};Ddb.TooltipWidget.prototype=new Ddb.Widget();(function(){Ddb.ViewModels.FacetValueViewModel=function(d,b,c,a){this.label=d;this.count=a;this.displayName=b;this.highlightedDisplayName=c;this.labelWithCount="<span class='label'><span class='count'>("+a.toLocaleString()+")</span>"+c+"</span>"}})();
